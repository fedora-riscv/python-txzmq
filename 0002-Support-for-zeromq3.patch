From 83564558aef9e4ab3a404bf748ba0f11ac862df0 Mon Sep 17 00:00:00 2001
From: Ralph Bean <rbean@redhat.com>
Date: Wed, 10 Oct 2012 13:04:53 -0400
Subject: [PATCH 1/3] Support for zeromq3.

---
 txzmq/connection.py | 24 ++++++++++++++++++++----
 1 file changed, 20 insertions(+), 4 deletions(-)

diff --git a/txzmq/connection.py b/txzmq/connection.py
index 19e4c3c..815c47d 100644
--- a/txzmq/connection.py
+++ b/txzmq/connection.py
@@ -3,7 +3,7 @@ ZeroMQ connection.
 """
 from collections import deque, namedtuple
 
-from zmq.core import constants, error
+from zmq.core import constants, error, version
 from zmq.core.socket import Socket
 
 from zope.interface import implements
@@ -12,6 +12,13 @@ from twisted.internet.interfaces import IFileDescriptor, IReadDescriptor
 from twisted.python import log
 
 
+# Patch zmq.core.constants to support both zeromq2 and zeromq3
+ZMQ3 = version.zmq_version_info()[0] >= 3
+
+if not ZMQ3:
+    constants.DONTWAIT = constants.NOBLOCK
+
+
 class ZmqEndpointType(object):
     """
     Endpoint could be "bound" or "connected".
@@ -77,10 +84,19 @@ class ZmqConnection(object):
 
         self.fd = self.socket.getsockopt(constants.FD)
         self.socket.setsockopt(constants.LINGER, factory.lingerPeriod)
-        self.socket.setsockopt(
-            constants.MCAST_LOOP, int(self.allowLoopbackMulticast))
+
+        if not ZMQ3:
+            self.socket.setsockopt(
+                constants.MCAST_LOOP, int(self.allowLoopbackMulticast))
+
         self.socket.setsockopt(constants.RATE, self.multicastRate)
-        self.socket.setsockopt(constants.HWM, self.highWaterMark)
+
+        if not ZMQ3:
+            self.socket.setsockopt(constants.HWM, self.highWaterMark)
+        else:
+            self.socket.setsockopt(constants.SNDHWM, self.highWaterMark)
+            self.socket.setsockopt(constants.RCVHWM, self.highWaterMark)
+
         if self.identity is not None:
             self.socket.setsockopt(constants.IDENTITY, self.identity)
 
-- 
1.7.12.1

